C251 COMPILER V5.60.0,  main                                                               18/07/23  21:03:50  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE main.c XSMALL BROWSE DEBUG PRINT(.\Listings\main.lst) TABS(2) OBJECT(.
                    -\Objects\main.obj) 

stmt  level    source

    1          //  @ٳ 2023/03/10
    2          //  PWMģʽʾʾģʽ1/2/3֧֣SMCR = 1ģʽ1SMCR = 2:ģʽ2SMCR = 3ģʽ3
    3          //  EC11ı
    4          //  EC11Ŷ壺A-P1.0B-P5.4
    5          //  MAX7219ģŶ壺CS = P6^5;DIN = P6^6;CLK = P6^4;MAX7219.h޸ģ
    6          //  ʵ鿪壺.1 @Ƶ12MHz
    7          
    8          #include "stc32g.h"
    9          #include "config.h"
   10          #include "MAX7219.h"
   11          
   12          void SYS_Ini();               // STC32ʼ
   13          void EC11_Handle();           // EC11ݴ
   14          void SEG_Disp(void);          // ʾ
   15          void PWM_Config();            // PWMʼ
   16          
   17          u8 cnt_H, cnt_L;              // ֵ8λ8λ
   18          u16 count,newcount;           // ǰֵϴμֵ
   19          u8 number;                    // ȼֵ
   20          bit numberchange;             // ȸı־
   21          
   22          void UartInit(void)   //115200@24.000MHz
   23          {
   24   1        SCON = 0x50;    //8λ,ɱ䲨
   25   1        AUXR |= 0x40;   //ʱ1ʱΪFosc,1T
   26   1        AUXR &= 0xFE;   //1ѡʱ1Ϊʷ
   27   1        TMOD &= 0x0F;   //趨ʱ1Ϊ16λԶװʽ
   28   1        TL1 = 0xCC;     //öʱʼֵ
   29   1        TH1 = 0xFF;     //öʱʼֵ
   30   1        ET1 = 0;    //ֹʱ1ж
   31   1        TR1 = 1;    //ʱ1
   32   1        ES=1;
   33   1        //  ES=0;//رմ0ж
   34   1        EA=1;
   35   1      }
   36          
   37          void testmain();
   38          
   39          
   40          
   41          void SYS_Ini()                // STC32ʼ
   42          {
   43   1        EAXFR = 1;                  // ʹܷ XFR
   44   1        CKCON = 0x00;               // ⲿٶΪ
   45   1        WTST = 0x00;                // óȴֵΪ 0 ɽ CPU ִгٶΪ
   46   1        P0M1 = 0x00;P0M0 = 0x00;    // P0Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   47   1        P1M1 = 0x00;P1M0 = 0x00;    // P1Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   48   1        P2M1 = 0x00;P2M0 = 0x00;    // P2Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   49   1        P3M1 = 0x00;P3M0 = 0x00;    // P3Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   50   1        P4M1 = 0x00;P4M0 = 0x00;    // P4Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   51   1        P5M1 = 0x00;P5M0 = 0x00;    // P5Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   52   1        P6M1 = 0x00;P6M0 = 0x00;    // P6Ϊ׼˫ģʽ //00׼˫ 01 10 11©
C251 COMPILER V5.60.0,  main                                                               18/07/23  21:03:50  PAGE 2   

             -
   53   1        P7M1 = 0x00;P7M0 = 0x00;    // P7Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   54   1      }
   55          
   56          void sendbyte1(unsigned char ch)
   57          {
   58   1        int i;
   59   1        // EA=0;
   60   1          TI     =   0;  //㴮ڷж־
   61   1          SBUF   =   ch;
   62   1          while(TI ==0) //ȴ
   63   1        {
   64   2          for(i=0;i<2000; i++){
   65   3            if( TI) break;
   66   3          }
   67   2          break;
   68   2        }
   69   1        EA=1;
   70   1      }
   71          char putchar (char dat)
   72          {
   73   1        // Delay1us();
   74   1        sendbyte1(dat);
   75   1        return (dat);
   76   1      }
   77          void UARTInterrupt(void) interrupt 4
   78          {
   79   1          unsigned char ans;
   80   1          if (RI)
   81   1          {
   82   2              RI = 0;
   83   2              ans = SBUF;
   84   2              // chuankou1jisuuan(ans);
   85   2          }
   86   1          else
   87   1          {
   88   2              TI = 0;
   89   2          }
   90   1          if (TI) // ж..
   91   1          {
   92   2              TI = 0;
   93   2          }
   94   1      }
   95          void testmain()
   96          {
   97   1        SYS_Ini();
   98   1         UartInit();
   99   1         while (1)
  100   1         {
  101   2           sendbyte1('a');
  102   2         }
  103   1      }
  104          void main(void)
  105          {
  106   1        testmain();
  107   1        SYS_Ini();                  // STC32ʼ
  108   1        PWM_Config();               // PWMʼ
  109   1        EA = 1;                     // ʹEAж
  110   1        MAX7219_Ini();              // MAX7219ʼ
  111   1        number = 10;                // ʼ10
  112   1        SEG_Disp();                 // ʾ
  113   1        while (1)
  114   1        {
  115   2          if(numberchange == 1)     // ıȱ־1
  116   2          {
C251 COMPILER V5.60.0,  main                                                               18/07/23  21:03:50  PAGE 3   

  117   3            Write7219(INTENSITY,number);  // 
  118   3            SEG_Disp();             // ˢʾ
  119   3            numberchange = 0;       // ıȱ־
  120   3          }
  121   2        }
  122   1      }
  123          void PWM_ISR() interrupt 26
  124          {
  125   1        if (PWMA_SR1 & 0X02)        // жϱ־1
  126   1        {
  127   2          cnt_H = PWMA_CCR1H;       // ȡֵ8λ
  128   2          cnt_L = PWMA_CCR1L;       // ȡֵ8λ
  129   2          PWMA_SR1 &= ~0X02;        // 㲶жϱ־
  130   2          EC11_Handle();              // EC11
  131   2        }
  132   1      }
  133          void PWM_Config()             // PWMʼ
  134          {
  135   1        PWMA_CCER1 = 0x00;          // رͨ
  136   1        PWMA_CCMR1 = 0xA1;          // ͨģʽΪ룬ӱ , ˲ 80 ʱ
  137   1        PWMA_CCMR2 = 0xA1;          // ͨģʽΪ룬ӱ , ˲ 80 ʱ
  138   1        PWMA_CCER1 = 0x55;          // ʹܲ/Ƚͨ1ͨ2
  139   1        
  140   1      //  PWMA_SMCR = 0x01;         // ģʽ 1
  141   1      //  PWMA_SMCR = 0x02;         // ģʽ 2 
  142   1        PWMA_SMCR = 0x03;           // ģʽ 3
  143   1        
  144   1        PWMA_IER = 0x02;            // ʹж
  145   1        PWMA_CR1 |= 0x01;           // ʹܼ
  146   1        PWMA_PS |= 0x08; //ѡ PWM2_2 ͨ
  147   1      }
  148          void EC11_Handle()            // EC11ݴ
  149          {
  150   1        newcount = cnt_H * 256 + cnt_L; // ȡǰֵ
  151   1        if(newcount < count)        // ǰֵСϴμֵ
  152   1        {
  153   2          if(number > 0)  number--; // ּ
  154   2          numberchange = 1;         // ȸı־1
  155   2          count = newcount;         // ¼ֵ
  156   2        }
  157   1        else if(newcount > count)   // ǰֵϴμֵ
  158   1        {
  159   2          if(number < 15) number++; // ּ
  160   2          numberchange = 1;         // ȸı־1
  161   2          count = newcount;         // ¼ֵ
  162   2        }
  163   1      }
  164          void SEG_Disp(void)                     
  165          {             
  166   1        Write7219(8,15);            // 1λϨ
  167   1        Write7219(7,15);            // 2λϨ
  168   1        Write7219(6,15);            // 3λϨ
  169   1        Write7219(5,15);            // 4λϨ
  170   1        Write7219(4,15);            // 5λϨ
  171   1        Write7219(3,15);            // 6λϨ
  172   1        Write7219(2,(u8)(number / 10));   // 7λʾʮλ
  173   1        Write7219(1,(u8)(number % 10));   // 8λʾָλ
  174   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       554     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
C251 COMPILER V5.60.0,  main                                                               18/07/23  21:03:50  PAGE 4   

  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =         7     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
