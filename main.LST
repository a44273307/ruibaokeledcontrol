C51 COMPILER V9.05   MAIN                                                                  06/04/2023 17:04:34 PAGE 1   


C51 COMPILER V9.05, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /************************************************************************************
   2             
   3          程序名称： （晶振频率18.432MHz） 
   4          功能说明: 通过串口3发送“Everything is possible!”  
   5                    波特率9600，数据位8，奇偶效验无，停止位1，数据流控制无  
   6          ************************************************************************************/
   7          #include "stc15f2k60s2.h"           // 单片机STC15F2K60S2头文件,可以不再加入reg51.h
   8          #include <intrins.h>                                    // 加入此头文件后,可使用_nop_库函数
   9          #include "delay.h"                      // 延时函数头文件
  10          #include "uart.h"                               // 串行通信函数头文件
  11          #define  uint unsigned int  
  12          #define  uchar unsigned char    
  13          #include <stdio.h>
  14          #include <string.h>
  15          #include "MODBUS.h"
  16          
  17          #include <stdio.h>
  18          #include <string.h>
  19          #include <stdlib.h>
  20          
  21          uint temp1,temp2,temp3,temp4;
  22          
  23          
  24          void io_inint()
  25          {
  26   1              P0M1 = 0;       P0M0 = 0;       //设置P0.0~P0.7为准双向口
  27   1        P1M0 = 0x00; // 设置P1.0为ADC口
  28   1        P1M1 = 0x80;
  29   1              P2M1 = 0;       P2M0 = 0;       //设置P2.0~P2.7为准双向口 
  30   1                  P3M0 = 0;
  31   1          P3M1 = 0;
  32   1              P4M1 = 0;       P4M0 = 0;       //设置P4.0~P4.7为准双向口
  33   1              // P5M1 = 0;    P5M0 = 0;       //设置P5.0~P5.7为准双向口
  34   1      
  35   1                  P5M0 = 0xff; P5M1 = 0x00; 
  36   1      
  37   1      }
  38          
  39          void Delay1ms()         //@24.000MHz
  40          {
  41   1              unsigned char i, j;
  42   1      
  43   1              i = 24;
  44   1              j = 85;
  45   1              do
  46   1              {
  47   2                      while (--j);
  48   2              } while (--i);
  49   1      }
  50          
  51          void delay_ms(int m)
  52          {
  53   1              int x;
  54   1              for(x=m;x>0;x--)
  55   1              {
C51 COMPILER V9.05   MAIN                                                                  06/04/2023 17:04:34 PAGE 2   

  56   2                      Delay1ms();
  57   2              }
  58   1              
  59   1      }
  60          
  61          sbit out1=P1^6;  //
  62          sbit out2=P3^2;
  63          
  64          extern void deanyan();
  65          sbit fen=P5^4;
  66          void testxx()
  67          {
  68   1                 P5M0 = 0x00; P5M1 = 0x00; 
  69   1               while (1)
  70   1               {
  71   2                      PrintString("ddd is ok\n");
  72   2                      P5=~P5;
  73   2                      // fen=;
  74   2                      delay_ms(1000);
  75   2                      
  76   2               }
  77   1      }
  78          void main()                                                    
  79          {
  80   1              
  81   1              io_inint();
  82   1              Uart23Init();
  83   1              
  84   1              
  85   1              Timer0Init();
  86   1              
  87   1              
  88   1              Uart4Init();
  89   1              // PrintString("system is ok\n");
  90   1              P_SW2 = 0x80;
  91   1          I2CCFG = 0xe0;                              //使能I2C主机模式
  92   1          I2CMSST = 0x00;
  93   1               EA = 1;
  94   1              out2=1;
  95   1              out1 = 1;
  96   1              delay_ms(10);
  97   1              Modbus_ClearBuff();
  98   1              out1 = 0;
  99   1              UartInit();
 100   1              delay_ms(100);
 101   1                      delay_ms(100);
 102   1                              delay_ms(100);
 103   1      
 104   1              testxx();
 105   1              while (1)
 106   1              {
 107   2                      delay_ms(1);
 108   2                      // printf("0000000000");
 109   2                      if(recover==1)
 110   2                      {
 111   3                              // deanyan();
 112   3                              jishouokjisuan();
 113   3                              recover=0;
 114   3                              deanyan();
 115   3                      }
 116   2              }
 117   1      }
C51 COMPILER V9.05   MAIN                                                                  06/04/2023 17:04:34 PAGE 3   

 118                   
 119                   
 120          
 121                   
 122                   
 123          uint time,lv_bo;
 124          void Timer0() interrupt 1
 125          {
 126   1              time1msjisuan();
 127   1      }
 128          void UARTInterrupt(void) interrupt 4
 129          {
 130   1              unsigned char ans;
 131   1              if (RI)
 132   1              {
 133   2                      RI = 0;
 134   2                      ans=SBUF;
 135   2                      IAP_CONTR=0x60;
 136   2                      chuankou1jisuuan(ans);
 137   2              }
 138   1              else
 139   1              {
 140   2                      TI = 0;
 141   2              }
 142   1              if (TI) //发送中断..
 143   1              {
 144   2                      TI = 0;
 145   2              }
 146   1      }
 147          
 148          void uart2(void ) interrupt 8 
 149          {
 150   1        if (S2CON & S2RI)
 151   1              {
 152   2                      S2CON &= ~S2RI;         
 153   2                      temp2 = S2BUF;
 154   2              }
 155   1        if (S2CON & S2TI)
 156   1          {
 157   2                              //y1=0;
 158   2              S2CON &= ~S2TI;         //清除S2TI位
 159   2              busy2 = 0;               //清忙标志
 160   2          }  
 161   1      }
 162          
 163            
 164          
 165          
 166          void Uart3() interrupt 17 using 1
 167          {
 168   1          if (S3CON & S3RI)
 169   1          {
 170   2              S3CON &= ~S3RI;         //??S3RI?
 171   2              temp3 = S3BUF;
 172   2                                      
 173   2         }
 174   1      if (S3CON & S3TI)
 175   1          {
 176   2              S3CON &= ~S3TI;         //清除S3TI位
 177   2              busy3 = 0;               //清忙标志
 178   2          }
 179   1      }
C51 COMPILER V9.05   MAIN                                                                  06/04/2023 17:04:34 PAGE 4   

 180          
 181          void Uart4() interrupt 18 
 182          {
 183   1          if (S4CON & S4RI)
 184   1          {
 185   2              S4CON &= ~S4RI;         //??S4RI?
 186   2              temp4=S4BUF;
 187   2         }
 188   1      if(TI4)
 189   1              {
 190   2                      CLR_TI4();
 191   2                      busy4 = 0;               //清忙标志
 192   2              }
 193   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    474    ----
   CONSTANT SIZE    =     11    ----
   XDATA SIZE       =     12    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
