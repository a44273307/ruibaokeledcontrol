C251 COMPILER V5.60.0,  APP_SPI_PS                                                         26/07/23  10:58:26  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE APP_SPI_PS
OBJECT MODULE PLACED IN .\list\APP_SPI_PS.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5 c251\C251\BIN\C251.EXE ..\App\src\APP_SPI_PS.c XSMALL INTR2 BROWSE I
                    -NCDIR(..\Driver\inc;..\User;..\App\inc) DEBUG PRINT(.\list\APP_SPI_PS.lst) OBJECT(.\list\APP_SPI_PS.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* --- STC MCU Limited ------------------------------------------------*/
    3          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
    4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
    5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
    6          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
    7          /* --- Web: www.STCMCU.com --------------------------------------------*/
    8          /* --- Web: www.STCMCUDATA.com  ---------------------------------------*/
    9          /* --- QQ:  800003751 -------------------------------------------------*/
   10          /* 如果要在程序中使用此代码,请在程序中注明使用了STC的资料及程序            */
   11          /*---------------------------------------------------------------------*/
   12          
   13          #include        "APP.h"
   14          #include        "STC32G_GPIO.h"
   15          #include        "STC32G_SPI.h"
   16          #include        "STC32G_UART.h"
   17          #include        "STC32G_NVIC.h"
   18          
   19          /*************  功能说明        **************
   20          
   21          通过串口发送数据给MCU1，MCU1将接收到的数据由SPI发送给MCU2，MCU2再通过串口发送出去.
   22          
   23          设置方法 2：
   24          两个设备初始化时都设置 SSIG 为 0，MSTR 设置为0，此时两个设备都是不忽略 SS 的从机模式。
   25          当其中一个设备需要启动传输时，先检测 SS 管脚的电平，如果时候高电平，
   26          就将自己设置成忽略 SS 的主模式，自己的 SS 脚输出低电平，拉低对方的 SS 脚，即可进行数据传输。
   27          
   28                   MCU1                          MCU2
   29            |-----------------|           |-----------------|
   30            |            MISO |-----------| MISO            |
   31          --| TX         MOSI |-----------| MOSI         TX |--
   32            |            SCLK |-----------| SCLK            |
   33          --| RX           SS |-----------| SS           RX |--
   34            |-----------------|           |-----------------|
   35          
   36          
   37          下载时, 选择时钟 24MHz (可以在配置文件"config.h"中修改).
   38          
   39          ******************************************/
   40          
   41          //========================================================================
   42          //                               本地常量声明   
   43          //========================================================================
   44          
   45          
   46          //========================================================================
   47          //                               本地变量声明
   48          //========================================================================
   49          
   50          bit UartReceived=0;
   51          
   52          //========================================================================
   53          //                               本地函数声明
   54          //========================================================================
   55          
   56          
   57          //========================================================================
   58          //                            外部函数和变量声明
C251 COMPILER V5.60.0,  APP_SPI_PS                                                         26/07/23  10:58:26  PAGE 2   

   59          //========================================================================
   60          
   61          
   62          //========================================================================
   63          // 函数: SPI_PS_init
   64          // 描述: 用户初始化程序.
   65          // 参数: None.
   66          // 返回: None.
   67          // 版本: V1.0, 2020-09-27
   68          //========================================================================
   69          void SPI_PS_init(void)
   70          {
   71   1              SPI_InitTypeDef         SPI_InitStructure;
   72   1              COMx_InitDefine         COMx_InitStructure;                                     //结构定义
   73   1      
   74   1              COMx_InitStructure.UART_Mode      = UART_8bit_BRTx;             //模式,   UART_ShiftRight,UART_8bit_BRTx,UART_9bit,
             -UART_9bit_BRTx
   75   1      //      COMx_InitStructure.UART_BRT_Use   = BRT_Timer2;                 //选择波特率发生器, BRT_Timer2 (注意: 串口2固定使用B
             -RT_Timer2, 所以不用选择)
   76   1              COMx_InitStructure.UART_BaudRate  = 115200ul;                   //波特率,     110 ~ 115200
*** WARNING C188 IN LINE 76 OF ..\App\src\APP_SPI_PS.c: 'constant': value truncated
   77   1              COMx_InitStructure.UART_RxEnable  = ENABLE;                             //接收允许,   ENABLE 或 DISABLE
   78   1              UART_Configuration(UART2, &COMx_InitStructure);         //初始化串口2 UART1,UART2,UART3,UART4
   79   1              NVIC_UART2_Init(ENABLE,Priority_1);             //中断使能, ENABLE/DISABLE; 优先级(低到高) Priority_0,Priority_1,Pr
             -iority_2,Priority_3
   80   1      
   81   1              SPI_InitStructure.SPI_Enable    = ENABLE;                                               //SPI启动    ENABLE, DISABLE
   82   1              SPI_InitStructure.SPI_SSIG      = ENABLE;                                               //片选位     ENABLE, DISABLE
   83   1              SPI_InitStructure.SPI_FirstBit  = SPI_MSB;                                      //移位方向   SPI_MSB, SPI_LSB
   84   1              SPI_InitStructure.SPI_Mode      = SPI_Mode_Slave;               //主从选择   SPI_Mode_Master, SPI_Mode_Slave
   85   1              SPI_InitStructure.SPI_CPOL      = SPI_CPOL_Low;                 //时钟相位   SPI_CPOL_High,   SPI_CPOL_Low
   86   1              SPI_InitStructure.SPI_CPHA      = SPI_CPHA_2Edge;               //数据边沿   SPI_CPHA_1Edge,  SPI_CPHA_2Edge
   87   1              SPI_InitStructure.SPI_Speed     = SPI_Speed_4;                  //SPI速度    SPI_Speed_4, SPI_Speed_8, SPI_Speed_16, SP
             -I_Speed_2
   88   1              SPI_Init(&SPI_InitStructure);
   89   1              NVIC_SPI_Init(ENABLE,Priority_3);               //中断使能, ENABLE/DISABLE; 优先级(低到高) Priority_0,Priority_1,Prio
             -rity_2,Priority_3
   90   1      
   91   1              P2_MODE_IO_PU(GPIO_Pin_All);            //P2 设置为准双向口
   92   1              P4_MODE_IO_PU(GPIO_Pin_6 | GPIO_Pin_7);         //P4.6,P4.7 设置为准双向口
   93   1      
   94   1              SPI_SS_2 = 1;
   95   1      }
   96          
   97          //========================================================================
   98          // 函数: Sample_SPI_PS
   99          // 描述: 用户应用程序.
  100          // 参数: None.
  101          // 返回: None.
  102          // 版本: V1.0, 2020-09-27
  103          //========================================================================
  104          void Sample_SPI_PS(void)
  105          {
  106   1              u8 i;
  107   1              
  108   1              if(COM2.RX_TimeOut > 0)
  109   1              {
  110   2                      if(--COM2.RX_TimeOut == 0)
  111   2                      {
  112   3                              if(COM2.RX_Cnt > 0)
  113   3                              {
  114   4                                      UartReceived = 1;   //设置串口接收标志
  115   4                              }
  116   3                      }
  117   2              }
  118   1              if((UartReceived) && (SPI_SS_2))
C251 COMPILER V5.60.0,  APP_SPI_PS                                                         26/07/23  10:58:26  PAGE 3   

  119   1              {
  120   2                      SPI_SS_2 = 0;     //拉低从机 SS 管脚
  121   2                      SPI_SetMode(SPI_Mode_Master);
  122   2                      for(i=0;i<COM2.RX_Cnt;i++)
  123   2                      {
  124   3                              SPI_WriteByte(RX2_Buffer[i]); //发送串口数据
  125   3                      }
  126   2                      SPI_SS_2 = 1;    //拉高从机的 SS 管脚
  127   2                      SPI_SetMode(SPI_Mode_Slave);
  128   2                      COM2.RX_Cnt = 0;
  129   2                      UartReceived = 0;
  130   2              }
  131   1              
  132   1              if(SPI_RxTimerOut > 0)
  133   1              {
  134   2                      if(--SPI_RxTimerOut == 0)
  135   2                      {
  136   3                              if(SPI_RxCnt > 0)
  137   3                              {
  138   4                                      for(i=0; i<SPI_RxCnt; i++)      TX2_write2buff(SPI_RxBuffer[i]);
  139   4                              }
  140   3                              SPI_RxCnt = 0;
  141   3                      }
  142   2              }
  143   1      }
  144          
  145          
  146          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       237     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------         14
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
