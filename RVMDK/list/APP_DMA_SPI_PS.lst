C251 COMPILER V5.60.0,  APP_DMA_SPI_PS                                                     26/07/23  10:58:27  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE APP_DMA_SPI_PS
OBJECT MODULE PLACED IN .\list\APP_DMA_SPI_PS.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5 c251\C251\BIN\C251.EXE ..\App\src\APP_DMA_SPI_PS.c XSMALL INTR2 BROW
                    -SE INCDIR(..\Driver\inc;..\User;..\App\inc) DEBUG PRINT(.\list\APP_DMA_SPI_PS.lst) OBJECT(.\list\APP_DMA_SPI_PS.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* --- STC MCU Limited ------------------------------------------------*/
    3          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
    4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
    5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
    6          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
    7          /* --- Web: www.STCMCU.com --------------------------------------------*/
    8          /* --- Web: www.STCMCUDATA.com  ---------------------------------------*/
    9          /* --- QQ:  800003751 -------------------------------------------------*/
   10          /* 如果要在程序中使用此代码,请在程序中注明使用了STC的资料及程序            */
   11          /*---------------------------------------------------------------------*/
   12          
   13          #include        "APP_DMA_SPI_PS.h"
   14          #include        "STC32G_GPIO.h"
   15          #include        "STC32G_SPI.h"
   16          #include        "STC32G_UART.h"
   17          #include        "STC32G_NVIC.h"
   18          #include        "STC32G_DMA.h"
   19          
   20          /*************  功能说明        **************
   21          
   22          UART_DMA, M2M_DMA, SPI_DMA 综合使用演示例程.
   23          
   24          通过串口发送数据给MCU1，MCU1将接收到的数据由SPI发送给MCU2，MCU2再通过串口发送出去.
   25          
   26          通过串口发送数据给MCU2，MCU2将接收到的数据由SPI发送给MCU1，MCU1再通过串口发送出去.
   27          
   28          MCU1/MCU2: UART接收 -> UART Rx DMA -> M2M -> SPI Tx DMA -> SPI发送
   29          
   30          MCU2/MCU1: SPI接收 -> SPI Rx DMA -> M2M -> UART Tx DMA -> UART发送
   31          
   32                   MCU1                          MCU2
   33            |-----------------|           |-----------------|
   34            |            MISO |-----------| MISO            |
   35          --| TX         MOSI |-----------| MOSI         TX |--
   36            |            SCLK |-----------| SCLK            |
   37          --| RX           SS |-----------| SS           RX |--
   38            |-----------------|           |-----------------|
   39          
   40          
   41          下载时, 选择时钟 24MHz (可以在配置文件"config.h"中修改).
   42          
   43          ******************************************/
   44          
   45          //========================================================================
   46          //                               本地常量声明   
   47          //========================================================================
   48          
   49          #define BUF_LENGTH          107                 //n+1
   50          
   51          //========================================================================
   52          //                               本地变量声明
   53          //========================================================================
   54          
   55          u8 xdata UartTxBuffer[256];
   56          u8 xdata UartRxBuffer[256];
   57          u8 xdata SpiTxBuffer[256];
   58          u8 xdata SpiRxBuffer[256];
C251 COMPILER V5.60.0,  APP_DMA_SPI_PS                                                     26/07/23  10:58:27  PAGE 2   

   59          
   60          //========================================================================
   61          //                               本地函数声明
   62          //========================================================================
   63          
   64          
   65          //========================================================================
   66          //                            外部函数和变量声明
   67          //========================================================================
   68          
   69          
   70          //========================================================================
   71          // 函数: DMA_SPI_PS_init
   72          // 描述: 用户初始化程序.
   73          // 参数: None.
   74          // 返回: None.
   75          // 版本: V1.0, 2021-05-27
   76          //========================================================================
   77          void DMA_SPI_PS_init(void)
   78          {
   79   1              SPI_InitTypeDef         SPI_InitStructure;
   80   1              COMx_InitDefine         COMx_InitStructure;                                     //结构定义
   81   1              DMA_M2M_InitTypeDef             DMA_M2M_InitStructure;          //结构定义
   82   1              DMA_SPI_InitTypeDef             DMA_SPI_InitStructure;          //结构定义
   83   1              DMA_UART_InitTypeDef    DMA_UART_InitStructure;         //结构定义
   84   1      
   85   1              //----------------------------------------------
   86   1              P2_MODE_IO_PU(GPIO_Pin_All);            //P2 设置为准双向口
   87   1              P4_MODE_IO_PU(GPIO_Pin_6 | GPIO_Pin_7);         //P4.6,P4.7 设置为准双向口
   88   1      
   89   1              SPI_SS_2 = 1;
   90   1      
   91   1              //----------------------------------------------
   92   1              COMx_InitStructure.UART_Mode      = UART_8bit_BRTx;             //模式,   UART_ShiftRight,UART_8bit_BRTx,UART_9bit,
             -UART_9bit_BRTx
   93   1      //      COMx_InitStructure.UART_BRT_Use   = BRT_Timer2;                 //选择波特率发生器, BRT_Timer2 (注意: 串口2固定使用B
             -RT_Timer2, 所以不用选择)
   94   1              COMx_InitStructure.UART_BaudRate  = 115200ul;                   //波特率,     110 ~ 115200
   95   1              COMx_InitStructure.UART_RxEnable  = ENABLE;                             //接收允许,   ENABLE 或 DISABLE
   96   1              UART_Configuration(UART2, &COMx_InitStructure);         //初始化串口2 UART1,UART2,UART3,UART4
   97   1              NVIC_UART2_Init(ENABLE,Priority_1);             //中断使能, ENABLE/DISABLE; 优先级(低到高) Priority_0,Priority_1,Pr
             -iority_2,Priority_3
   98   1              printf("STC32G UART-DMA-SPI互为主从透传程序.\r\n");
   99   1      
  100   1              //----------------------------------------------
  101   1              SPI_InitStructure.SPI_Enable    = ENABLE;                                               //SPI启动    ENABLE, DISABLE
  102   1              SPI_InitStructure.SPI_SSIG      = ENABLE;                                               //片选位     ENABLE, DISABLE
  103   1              SPI_InitStructure.SPI_FirstBit  = SPI_MSB;                                      //移位方向   SPI_MSB, SPI_LSB
  104   1              SPI_InitStructure.SPI_Mode      = SPI_Mode_Slave;               //主从选择   SPI_Mode_Master, SPI_Mode_Slave
  105   1              SPI_InitStructure.SPI_CPOL      = SPI_CPOL_Low;                 //时钟相位   SPI_CPOL_High,   SPI_CPOL_Low
  106   1              SPI_InitStructure.SPI_CPHA      = SPI_CPHA_1Edge;               //数据边沿   SPI_CPHA_1Edge,  SPI_CPHA_2Edge
  107   1              SPI_InitStructure.SPI_Speed     = SPI_Speed_16;                 //SPI速度    SPI_Speed_4, SPI_Speed_8, SPI_Speed_16, S
             -PI_Speed_2
  108   1              SPI_Init(&SPI_InitStructure);
  109   1              NVIC_SPI_Init(DISABLE,Priority_0);              //中断使能, ENABLE/DISABLE; 优先级(低到高) Priority_0,Priority_1,Pri
             -ority_2,Priority_3
  110   1      
  111   1              //----------------------------------------------
  112   1              DMA_UART_InitStructure.DMA_TX_Length = BUF_LENGTH;      //DMA传输总字节数       (0~65535) + 1
  113   1              DMA_UART_InitStructure.DMA_TX_Buffer = (u16)UartTxBuffer;       //发送数据存储地址
  114   1              DMA_UART_InitStructure.DMA_RX_Length = BUF_LENGTH;      //DMA传输总字节数       (0~65535) + 1
  115   1              DMA_UART_InitStructure.DMA_RX_Buffer = (u16)UartRxBuffer;       //接收数据存储地址
  116   1              DMA_UART_InitStructure.DMA_TX_Enable = ENABLE;          //DMA使能       ENABLE,DISABLE
  117   1              DMA_UART_InitStructure.DMA_RX_Enable = ENABLE;          //DMA使能       ENABLE,DISABLE
  118   1              DMA_UART_Inilize(UART2, &DMA_UART_InitStructure);       //初始化
  119   1      
C251 COMPILER V5.60.0,  APP_DMA_SPI_PS                                                     26/07/23  10:58:27  PAGE 3   

  120   1              NVIC_DMA_UART2_Tx_Init(ENABLE,Priority_0,Priority_0);           //中断使能, ENABLE/DISABLE; 优先级(低到高) Priori
             -ty_0~Priority_3; 总线优先级(低到高) Priority_0~Priority_3
  121   1              NVIC_DMA_UART2_Rx_Init(ENABLE,Priority_0,Priority_0);           //中断使能, ENABLE/DISABLE; 优先级(低到高) Priori
             -ty_0~Priority_3; 总线优先级(低到高) Priority_0~Priority_3
  122   1              DMA_UR2R_CLRFIFO();             //清空 DMA FIFO
  123   1              DMA_UR2R_TRIG();        //触发UART接收功能
  124   1      
  125   1              //----------------------------------------------
  126   1              DMA_M2M_InitStructure.DMA_Enable = ENABLE;                      //DMA使能       ENABLE,DISABLE
  127   1              DMA_M2M_InitStructure.DMA_Length = BUF_LENGTH;                  //DMA传输总字节数       (0~65535) + 1
  128   1              DMA_M2M_InitStructure.DMA_Tx_Buffer = (u16)UartRxBuffer;        //发送数据存储地址
  129   1              DMA_M2M_InitStructure.DMA_Rx_Buffer = (u16)SpiTxBuffer; //接收数据存储地址
  130   1              DMA_M2M_InitStructure.DMA_SRC_Dir = M2M_ADDR_INC;               //数据源地址改变方向    M2M_ADDR_INC,M2M_ADDR_DEC
  131   1              DMA_M2M_InitStructure.DMA_DEST_Dir = M2M_ADDR_INC;      //数据目标地址改变方向  M2M_ADDR_INC,M2M_ADDR_DEC
  132   1              DMA_M2M_Inilize(&DMA_M2M_InitStructure);                //初始化
  133   1              NVIC_DMA_M2M_Init(ENABLE,Priority_0,Priority_0);                //中断使能, ENABLE/DISABLE; 优先级(低到高) Priority_0~
             -Priority_3; 总线优先级(低到高) Priority_0~Priority_3
  134   1      
  135   1              //----------------------------------------------
  136   1              DMA_SPI_InitStructure.DMA_Enable = DISABLE;                                     //DMA使能       ENABLE,DISABLE
  137   1              DMA_SPI_InitStructure.DMA_Tx_Enable = ENABLE;                           //DMA发送数据使能       ENABLE,DISABLE
  138   1              DMA_SPI_InitStructure.DMA_Rx_Enable = ENABLE;                           //DMA接收数据使能       ENABLE,DISABLE
  139   1              DMA_SPI_InitStructure.DMA_Length = BUF_LENGTH;                  //DMA传输总字节数       (0~65535) + 1
  140   1              DMA_SPI_InitStructure.DMA_Tx_Buffer = (u16)SpiTxBuffer; //发送数据存储地址
  141   1              DMA_SPI_InitStructure.DMA_Rx_Buffer = (u16)SpiRxBuffer; //接收数据存储地址
  142   1              DMA_SPI_InitStructure.DMA_SS_Sel = SPI_SS_P22;                  //自动控制SS脚选择      SPI_SS_P12,SPI_SS_P22,SPI_SS_P74,SP
             -I_SS_P35
  143   1              DMA_SPI_InitStructure.DMA_AUTO_SS = DISABLE;                            //自动控制SS脚使能      ENABLE,DISABLE
  144   1              DMA_SPI_Inilize(&DMA_SPI_InitStructure);                //初始化
  145   1              SET_DMA_SPI_CR(DMA_ENABLE | SPI_TRIG_S | CLR_FIFO);     //bit7 1:使能 SPI_DMA, bit5 1:开始 SPI_DMA 从机模式,
             - bit0 1:清除 SPI_DMA FIFO
  146   1              NVIC_DMA_SPI_Init(ENABLE,Priority_0,Priority_0);                //中断使能, ENABLE/DISABLE; 优先级(低到高) Priority_0~
             -Priority_3; 总线优先级(低到高) Priority_0~Priority_3
  147   1      }
  148          
  149          void M2M_UART_SPI(u16 txbuf, u16 rxbuf)
  150          {
  151   1              DMA_M2M_CLR_STA();
  152   1              SET_M2M_TX_FIFO(txbuf);
  153   1              SET_M2M_RX_FIFO(rxbuf);
  154   1              DMA_M2M_TRIG();
  155   1      }
  156          
  157          void M2M_SPI_UART(u16 txbuf, u16 rxbuf)
  158          {
  159   1              DMA_M2M_CLR_STA();
  160   1              SET_M2M_TX_FIFO(txbuf);
  161   1              SET_M2M_RX_FIFO(rxbuf);
  162   1              DMA_M2M_TRIG();
  163   1      }
  164          
  165          void UART_DMA_Tx(void)
  166          {
  167   1              DMA_UR2T_TRIG();
  168   1      }
  169          
  170          void UART_DMA_Rx(void)
  171          {
  172   1              DMA_UR2R_TRIG();
  173   1      }
  174          
  175          void SPI_DMA_Master(void)
  176          {
  177   1              SET_DMA_SPI_CR(0);
  178   1              _nop_();
  179   1              _nop_();
C251 COMPILER V5.60.0,  APP_DMA_SPI_PS                                                     26/07/23  10:58:27  PAGE 4   

  180   1              _nop_();
  181   1              _nop_();
  182   1              _nop_();
  183   1              _nop_();
  184   1              SPI_SS_2 = 0;
  185   1              SPCTL = 0xd2;   //使能 SPI 主机模式，忽略SS引脚功能
  186   1              SET_DMA_SPI_CR(DMA_ENABLE | SPI_TRIG_M);        //bit7 1:使能 SPI_DMA, bit6 1:开始 SPI_DMA 主机模式
  187   1      }
  188          
  189          void SPI_DMA_Slave(void)
  190          {
  191   1              SET_DMA_SPI_CR(0);
  192   1              _nop_();
  193   1              _nop_();
  194   1              _nop_();
  195   1              _nop_();
  196   1              _nop_();
  197   1              _nop_();
  198   1              SPCTL = 0x42;  //重新设置为从机待机
  199   1              SET_DMA_SPI_CR(DMA_ENABLE | SPI_TRIG_S);        //bit7 1:使能 SPI_DMA, bit5 1:开始 SPI_DMA 从机模式
  200   1      }
  201          
  202          //========================================================================
  203          // 函数: Sample_DMA_SPI_PS
  204          // 描述: 用户应用程序.
  205          // 参数: None.
  206          // 返回: None.
  207          // 版本: V1.0, 2021-05-27
  208          //========================================================================
  209          void Sample_DMA_SPI_PS(void)
  210          {
  211   1              //UART接收 -> UART DMA -> SPI DMA -> SPI发送
  212   1              if(DmaRx2Flag)
  213   1              {
  214   2                      DmaRx2Flag = 0;
  215   2                      u2sFlag = 1;
  216   2                      M2M_UART_SPI((u16)UartRxBuffer,(u16)SpiTxBuffer);                       //UART Memory -> SPI Memory
  217   2              }
  218   1      
  219   1              if(SpiSendFlag)
  220   1              {
  221   2                      SpiSendFlag = 0;
  222   2                      UART_DMA_Rx();                  //UART Recive Continue
  223   2                      SPI_DMA_Master();               //SPI Send Memory
  224   2              }
  225   1      
  226   1              if(SpiTxFlag)
  227   1              {
  228   2                      SpiTxFlag = 0;
  229   2                      SPI_DMA_Slave();                //SPI Slave Mode
  230   2              }
  231   1      
  232   1              
  233   1              //SPI接收 -> SPI DMA -> UART DMA -> UART发送
  234   1              if(SpiRxFlag)
  235   1              {
  236   2                      SpiRxFlag = 0;
  237   2                      s2uFlag = 1;
  238   2                      M2M_SPI_UART((u16)SpiRxBuffer, (u16)UartTxBuffer);                      //SPI Memory -> UART Memory
  239   2              }
  240   1      
  241   1              if(UartSendFlag)
  242   1              {
  243   2                      UartSendFlag = 0;
  244   2                      SPI_DMA_Slave();                //SPI Slave Mode
  245   2                      UART_DMA_Tx();                  //UART Send Memory
C251 COMPILER V5.60.0,  APP_DMA_SPI_PS                                                     26/07/23  10:58:27  PAGE 5   

  246   2              }
  247   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       608     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =      1024     ------
  xdata-const size     =    ------     ------
  edata size           =    ------         46
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        39     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
