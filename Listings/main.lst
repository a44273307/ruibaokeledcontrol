C251 COMPILER V5.60.0,  main                                                               18/07/23  22:04:38  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE main.c XSMALL BROWSE DEBUG PRINT(.\Listings\main.lst) TABS(2) OBJECT(.
                    -\Objects\main.obj) 

stmt  level    source

    1          //  @ٳ 2023/03/10
    2          //  PWMģʽʾʾģʽ1/2/3֧֣SMCR = 1ģʽ1SMCR = 2:ģʽ2SMCR = 3ģʽ3
    3          //  EC11ı
    4          //  EC11Ŷ壺A-P1.0B-P5.4
    5          //  MAX7219ģŶ壺CS = P6^5;DIN = P6^6;CLK = P6^4;MAX7219.h޸ģ
    6          //  ʵ鿪壺.1 @Ƶ12MHz
    7          
    8          #include "stc32g.h"
    9          #include "config.h"
   10          #include "MAX7219.h"
   11          #include <stdio.h>
   12          #include <stdarg.h>
   13          
   14          void SYS_Ini();               // STC32ʼ
   15          void EC11_Handle();           // EC11ݴ
   16          void SEG_Disp(void);          // ʾ
   17          void PWM_Config();            // PWMʼ
   18          
   19          u8 cnt_H, cnt_L;              // ֵ8λ8λ
   20          u16 count,newcount;           // ǰֵϴμֵ
   21          u8 number;                    // ȼֵ
   22          bit numberchange;             // ȸı־
   23          
   24          void UartInit(void)   //115200@24.000MHz
   25          {
   26   1        SCON = 0x50;    //8λ,ɱ䲨
   27   1        AUXR |= 0x01;   //1ѡʱ2Ϊʷ
   28   1        AUXR |= 0x04;   //ʱʱ1Tģʽ
   29   1        T2L = 0xCC;     //öʱʼֵ
   30   1        T2H = 0xFF;     //öʱʼֵ
   31   1        AUXR |= 0x10;   //ʱ2ʼʱ
   32   1        ES=1;
   33   1        //  ES=0;//رմ0ж
   34   1        EA=1;
   35   1      }
   36          
   37          
   38          
   39          
   40          void SYS_Ini()                // STC32ʼ
   41          {
   42   1        EAXFR = 1;                  // ʹܷ XFR
   43   1        CKCON = 0x00;               // ⲿٶΪ
   44   1        WTST = 0x00;                // óȴֵΪ 0 ɽ CPU ִгٶΪ
   45   1        P0M1 = 0x00;P0M0 = 0x00;    // P0Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   46   1        P1M1 = 0x00;P1M0 = 0x00;    // P1Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   47   1        P2M1 = 0x00;P2M0 = 0x00;    // P2Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   48   1        P3M1 = 0x00;P3M0 = 0x00;    // P3Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   49   1        P4M1 = 0x00;P4M0 = 0x00;    // P4Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   50   1        P5M1 = 0x00;P5M0 = 0x00;    // P5Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   51   1        P6M1 = 0x00;P6M0 = 0x00;    // P6Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
C251 COMPILER V5.60.0,  main                                                               18/07/23  22:04:38  PAGE 2   

   52   1        P7M1 = 0x00;P7M0 = 0x00;    // P7Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   53   1      }
   54          
   55          void sendbyte1(unsigned char ch)
   56          {
   57   1        int i;
   58   1        // EA=0;
   59   1          TI     =   0;  //㴮ڷж־
   60   1          SBUF   =   ch;
   61   1          while(TI ==0) //ȴ
   62   1        {
   63   2          for(i=0;i<2000; i++){
   64   3            if( TI) break;
   65   3          }
   66   2          break;
   67   2        }
   68   1        EA=1;
   69   1      }
   70          char putchar (char dat)
   71          {
   72   1        // Delay1us();
   73   1        sendbyte1(dat);
   74   1        return (dat);
   75   1      }
   76          void UARTInterrupt(void) interrupt 4
   77          {
   78   1          unsigned char ans;
   79   1          if (RI)
   80   1          {
   81   2              RI = 0;
   82   2              ans = SBUF;
   83   2              // chuankou1jisuuan(ans);
   84   2          }
   85   1          else
   86   1          {
   87   2              TI = 0;
   88   2          }
   89   1          if (TI) // ж..
   90   1          {
   91   2              TI = 0;
   92   2          }
   93   1      }
   94          void Delay100ms()   //@24.000MHz
   95          {
   96   1        unsigned long i;
   97   1      
   98   1        _nop_();
   99   1        _nop_();
  100   1        i = 599998UL;
  101   1        while (i) i--;
  102   1      }
  103          // printf
  104          void printf1(const char *fmt, ...) {
  105   1         char *p;
  106   1          char buf[128];  // һ㹻洢ַ
  107   1          va_list args;
  108   1          va_start(args, fmt);
  109   1          vsprintf(buf, fmt, args);  // ʽַд뻺
  110   1          va_end(args);
  111   1          
  112   1           p = (unsigned char *)buf;
  113   1          while (*p != '\0')
  114   1        {
  115   2          sendbyte1(*p);
  116   2          p++;
C251 COMPILER V5.60.0,  main                                                               18/07/23  22:04:38  PAGE 3   

  117   2        }
  118   1      }
  119          void testmain()
  120          {
  121   1        int a,b;
  122   1        int times=0;
  123   1         UartInit();
  124   1         printf1("test run");
  125   1         while (1)
  126   1         {
  127   2        a=P2^2;
  128   2        b=P1^0;
  129   2      //    printf1("zhi%d-%d-%d",times++,a,b);
  130   2           Delay100ms();
  131   2        //    sendbyte1('a');
  132   2         }
  133   1      }
  134          void main(void)
  135          {
  136   1        
  137   1        SYS_Ini();                  // STC32ʼ
  138   1        PWM_Config();               // PWMʼ
  139   1        EA = 1;                     // ʹEAж
  140   1        MAX7219_Ini();              // MAX7219ʼ
  141   1        number = 10;                // ʼ10
  142   1        SEG_Disp();                 // ʾ
  143   1        testmain();
  144   1        while (1)
  145   1        {
  146   2          if(numberchange == 1)     // ıȱ־1
  147   2          {
  148   3            Write7219(INTENSITY,number);  // 
  149   3            SEG_Disp();             // ˢʾ
  150   3            numberchange = 0;       // ıȱ־
  151   3          }
  152   2        }
  153   1      }
  154          void PWM_ISR() interrupt 26
  155          {
  156   1        if (PWMA_SR1 & 0X02)        // жϱ־1
  157   1        {
  158   2          cnt_H = PWMA_CCR1H;       // ȡֵ8λ
  159   2          cnt_L = PWMA_CCR1L;       // ȡֵ8λ
  160   2          PWMA_SR1 &= ~0X02;        // 㲶жϱ־
  161   2          EC11_Handle();              // EC11
  162   2        }
  163   1      }
  164          void PWM_Config()             // PWMʼ
  165          {
  166   1        PWMA_CCER1 = 0x00;          // رͨ
  167   1        PWMA_CCMR1 = 0xA1;          // ͨģʽΪ룬ӱ , ˲ 80 ʱ
  168   1        PWMA_CCMR2 = 0xA1;          // ͨģʽΪ룬ӱ , ˲ 80 ʱ
  169   1        PWMA_CCER1 = 0x55;          // ʹܲ/Ƚͨ1ͨ2
  170   1        
  171   1      //  PWMA_SMCR = 0x01;         // ģʽ 1
  172   1      //  PWMA_SMCR = 0x02;         // ģʽ 2 
  173   1        PWMA_SMCR = 0x03;           // ģʽ 3
  174   1        
  175   1        PWMA_IER = 0x02;            // ʹж
  176   1        PWMA_CR1 |= 0x01;           // ʹܼ
  177   1        PWMA_PS |= 0x04; //ѡ PWM2_2 ͨ
  178   1      }
  179          
  180          
  181          
  182          // ر仯Ĳ
C251 COMPILER V5.60.0,  main                                                               18/07/23  22:04:38  PAGE 4   

  183          long  calculateChange(unsigned int previous, unsigned int current) {
  184   1        long  diff = (current - previous + 65536) % 65536;
*** WARNING C188 IN LINE 184 OF main.c: 'initialization': value truncated
  185   1        return diff;
  186   1      }
  187          
  188          
  189          
  190          
  191          void EC11_Handle()            // EC11ݴ
  192          {
  193   1        static unsigned int previous=0; 
  194   1        unsigned int  nowzhi;
  195   1        long ans;
  196   1        nowzhi = cnt_H * 256 + cnt_L; // ȡǰֵ
  197   1        ans=calculateChange(previous,nowzhi);
  198   1        previous=nowzhi;
  199   1        if(ans==4)
  200   1        {
  201   2          printf1("zheng");
  202   2        }
  203   1        else
  204   1        {
  205   2          printf1("fan");
  206   2        }
  207   1        // printf1("newcount %ld",ans);
  208   1        // if(newcount < count)         // ǰֵСϴμֵ
  209   1        // {
  210   1        //  if(number > 0)  number--; // ּ
  211   1        //  numberchange = 1;         // ȸı־1
  212   1        //  count = newcount;         // ¼ֵ
  213   1        // }
  214   1        // else if(newcount > count)    // ǰֵϴμֵ
  215   1        // {
  216   1        //  if(number < 15) number++; // ּ
  217   1        //  numberchange = 1;         // ȸı־1
  218   1        //  count = newcount;         // ¼ֵ
  219   1        // }
  220   1      }
  221          void SEG_Disp(void)                     
  222          {             
  223   1        Write7219(8,15);            // 1λϨ
  224   1        Write7219(7,15);            // 2λϨ
  225   1        Write7219(6,15);            // 3λϨ
  226   1        Write7219(5,15);            // 4λϨ
  227   1        Write7219(4,15);            // 5λϨ
  228   1        Write7219(3,15);            // 6λϨ
  229   1        Write7219(2,(u8)(number / 10));   // 7λʾʮλ
  230   1        Write7219(1,(u8)(number % 10));   // 8λʾָλ
  231   1      }
  232          
  233          // дǸǰǺˣ仯 15,16,0,1,2...15,16    


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       615     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =         9        172
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
C251 COMPILER V5.60.0,  main                                                               18/07/23  22:04:38  PAGE 5   

  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        25     ------
End of Module Information.


C251 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
